version: "3.8"

services:
  # --- ZooKeeper Cluster ---
  zk1:
    image: zookeeper:3.6
    container_name: zk1
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zk1:2888:3888;2181 server.2=zk2:2888:3888;2181 server.3=zk3:2888:3888;2181
    networks: [hadoop-net]
    ports: ["2181:2181"]
    
  zk2:
    image: zookeeper:3.6
    container_name: zk2
    environment:
      ZOO_MY_ID: 2
      ZOO_SERVERS: server.1=zk1:2888:3888;2181 server.2=zk2:2888:3888;2181 server.3=zk3:2888:3888;2181
    networks: [hadoop-net]
    ports: ["2182:2181"]
    
  zk3:
    image: zookeeper:3.6
    container_name: zk3
    environment:
      ZOO_MY_ID: 3
      ZOO_SERVERS: server.1=zk1:2888:3888;2181 server.2=zk2:2888:3888;2181 server.3=zk3:2888:3888;2181
    networks: [hadoop-net]
    ports: ["2183:2181"]

  # --- JournalNode Cluster ---
  jn1:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: jn1
    command: hdfs journalnode
    volumes:
      - ./config:/opt/hadoop/etc/hadoop:ro
      - ./data/jn1:/hadoop/dn
    networks: [hadoop-net]
    depends_on: [zk1, zk2, zk3]
    
  jn2:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: jn2
    command: hdfs journalnode
    volumes:
      - ./config:/opt/hadoop/etc/hadoop:ro
      - ./data/jn2:/hadoop/dn
    networks: [hadoop-net]
    depends_on: [zk1, zk2, zk3]
    
  jn3:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: jn3
    command: hdfs journalnode
    volumes:
      - ./config:/opt/hadoop/etc/hadoop:ro
      - ./data/jn3:/hadoop/dn
    networks: [hadoop-net]
    depends_on: [zk1, zk2, zk3]

  # --- NameNode HA ---
  nn1:
    image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
    container_name: nn1
    command: namenode-format-and-start  # 自定义命令，见下方说明
    volumes:
      - ./config:/opt/hadoop/etc/hadoop:ro
      - ./data/nn1:/hadoop/nn
    ports: ["9870:9870"]
    networks: [hadoop-net]
    depends_on: [jn1, jn2, jn3]
    
  nn2:
    image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
    container_name: nn2
    command: namenode-bootstrap-and-start
    volumes:
      - ./config:/opt/hadoop/etc/hadoop:ro
      - ./data/nn2:/hadoop/nn
    ports: ["9871:9870"]
    networks: [hadoop-net]
    depends_on: [nn1, jn1, jn2, jn3]

  # --- DataNode ---
  dn1:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: dn1
    volumes:
      - ./config:/opt/hadoop/etc/hadoop:ro
      - ./data/dn1:/hadoop/dn
    networks: [hadoop-net]
    depends_on: [nn1, nn2]
    
  dn2:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    container_name: dn2
    volumes:
      - ./config:/opt/hadoop/etc/hadoop:ro
      - ./data/dn2:/hadoop/dn
    networks: [hadoop-net]
    depends_on: [nn1, nn2]

  # --- ResourceManager HA ---
  rm1:
    image: bde2020/hadoop-resourcemanager:2.0.0-hadoop3.2.1-java8
    container_name: rm1
    volumes:
      - ./config:/opt/hadoop/etc/hadoop:ro
    ports: ["8088:8088"]
    networks: [hadoop-net]
    depends_on: [nn1, nn2]
    
  rm2:
    image: bde2020/hadoop-resourcemanager:2.0.0-hadoop3.2.1-java8
    container_name: rm2
    volumes:
      - ./config:/opt/hadoop/etc/hadoop:ro
    ports: ["8089:8088"]
    networks: [hadoop-net]
    depends_on: [nn1, nn2]

  # --- NodeManager ---
  nm1:
    image: bde2020/hadoop-nodemanager:2.0.0-hadoop3.2.1-java8
    container_name: nm1
    volumes:
      - ./config:/opt/hadoop/etc/hadoop:ro
    networks: [hadoop-net]
    depends_on: [rm1, rm2]
    
  nm2:
    image: bde2020/hadoop-nodemanager:2.0.0-hadoop3.2.1-java8
    container_name: nm2
    volumes:
      - ./config:/opt/hadoop/etc/hadoop:ro
    networks: [hadoop-net]
    depends_on: [rm1, rm2]

networks:
  hadoop-net:
    driver: bridge